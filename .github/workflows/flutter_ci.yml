name: Flutter CI

on:
  pull_request:
    branches:
      - master

permissions:
  pull-requests: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository code with full history
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Garantir que todo o histÃ³rico seja baixado

    # Step 2: Generate filtered diff for Gemini review (only .dart files)
    - name: Generate filtered diff for Gemini review
      run: git diff origin/master...HEAD -- '*.dart' > changes.diff

    # Step 3: Send the full diff to Gemini in one request
    - name: Send full diff to Gemini
      id: gemini_review
      run: |
        # Read the full diff content into a variable
        DIFF_CONTENT=$(cat changes.diff)

        # Escape the full DIFF_CONTENT for JSON
        ESCAPED_DIFF=$(jq -Rs . <<< "$DIFF_CONTENT")

        # Optimized review message
        FULL_CONTENT="ðŸ” **Resumo Detalhado das AlteraÃ§Ãµes do PR:**\nResumo detalhado das alteraÃ§Ãµes:\n$DIFF_CONTENT\n\nðŸ“ **Boas prÃ¡ticas de Flutter:**\nO cÃ³digo segue boas prÃ¡ticas de Flutter? Cite exemplos claros de prÃ¡ticas especÃ­ficas relacionadas a widgets, state management e arquitetura.\n\nâš ï¸ **Riscos de Bugs:**\nIdentifique e descreva riscos especÃ­ficos de bugs com base no cÃ³digo fornecido.\n\nðŸ›  **SugestÃµes de RefatoraÃ§Ã£o (com exemplos de cÃ³digo):**\nSugira melhorias no cÃ³digo com exemplos prÃ¡ticos:\n```dart\nvoid exampleRefactor() {\n  // Exemplo de refatoraÃ§Ã£o\n}\n```\n\nðŸ’¡ **DÃ­vidas TÃ©cnicas:**\nListe as dÃ­vidas
